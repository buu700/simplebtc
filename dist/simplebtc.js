"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof")),isNode="object"===("undefined"==typeof process?"undefined":(0,_typeof2.default)(process))&&"function"==typeof require&&"object"!==("undefined"==typeof window?"undefined":(0,_typeof2.default)(window))&&"function"!=typeof importScripts,rootScope=isNode?global:self,_require=require("bitcore-lib/lib/address"),addressIsValid=_require.isValid,BitcorePrivateKey=require("bitcore-lib/lib/privatekey"),BitcoreTransaction=require("bitcore-lib/lib/transaction"),FormData=require("form-data"),_require2=require("rxjs"),ReplaySubject=_require2.ReplaySubject,Subject=_require2.Subject,_require3=require("rxjs/operators"),map=_require3.map,mergeMap=_require3.mergeMap,fetch="function"==typeof rootScope.fetch?rootScope.fetch:isNode?eval("require")("node-fetch"):require("whatwg-fetch"),sleep=function(){var e=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(){var r,t=arguments;return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.length>0&&void 0!==t[0]?t[0]:250,e.abrupt("return",new Promise((function(e){setTimeout(e,r)})));case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),locks={},lock=function(){var e=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(r,t){var n,a,s=arguments;return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=s.length>2&&void 0!==s[2]?s[2]:0,locks[r]||(locks[r]=Promise.resolve()),a=locks[r].then((0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t());case 1:case"end":return e.stop()}}),e)})))),locks[r]=a.catch((function(){})).then((0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",sleep(n));case 1:case"end":return e.stop()}}),e)})))),e.abrupt("return",a);case 5:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}(),request=function(){var e=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(r,t){var n,a,s,o,i=arguments;return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=i.length>2&&void 0!==i[2]?i[2]:0,a=i.length>3&&void 0!==i[3]?i[3]:2,s=i.length>4&&void 0!==i[4]?i[4]:0,e.prev=3,e.next=6,lock("request",(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",fetch(r,t));case 1:case"end":return e.stop()}}),e)}))));case 6:if(200===(o=e.sent).status){e.next=9;break}throw new Error("Request failure: status ".concat(o.status.toString()));case 9:return e.abrupt("return",o);case 12:if(e.prev=12,e.t0=e.catch(3),!(s>=a)){e.next=16;break}throw e.t0;case 16:return e.next=18,sleep(n+1e3);case 18:return e.abrupt("return",request(r,t,n,a,s+1));case 19:case"end":return e.stop()}}),e,null,[[3,12]])})));return function(r,t){return e.apply(this,arguments)}}(),satoshiConversion=1e8,transactionFee=5430,blockchainAPIKey=void 0,blockchainAPIURL="https://blockchain.info/",blockchainWebSocketURL="wss://ws.blockchain.info/inv",blockchainAPI=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return!1!==r.cors&&(r.cors=!0),blockchainAPIKey&&(r.key=blockchainAPIKey),"".concat(blockchainAPIURL+e,"?").concat(Object.keys(r).map((function(e){return"".concat(e,"=").concat(r[e])})).join("&"))},blockchainAPIRequest=function(){var e=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(r,t){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",request(blockchainAPI(r,t),void 0,blockchainAPIKey?0:1e4).then(function(){var e=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(r){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r.json());case 1:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})));return function(r,t){return e.apply(this,arguments)}}(),getExchangeRates=function(){var e=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(){var r,t;return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,blockchainAPIRequest("ticker");case 2:for(t in r=e.sent)r[t]=r[t].last;return r.BTC=1,e.abrupt("return",r);case 6:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),setBlockchainAPIKey=function(e){blockchainAPIKey=e},Wallet=function(){function e(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if((0,_classCallCheck2.default)(this,e),this.apiKey=r.apiKey,r instanceof e)return this.address=r.address,this.isReadOnly=r.isReadOnly,this.localCurrency=r.localCurrency,this.key=r.key,this.originatingTransactions=r.originatingTransactions,void(this.subjects={});this.localCurrency=r.localCurrency||"BTC";var t="string"==typeof r.key?new BitcorePrivateKey(r.key,"livenet").toBuffer():r.key instanceof Uint8Array?r.key:void 0;if(void 0!==t?this.key=BitcorePrivateKey.fromObject({bn:t,compressed:!r.uncompressedPublicKey,network:"livenet"}):r.address||(this.key=new BitcorePrivateKey(void 0,"livenet")),this.isReadOnly=void 0===this.key,this.address=this.isReadOnly?r.address:this.key.toAddress().toString(),this.originatingTransactions={},this.subjects={},!addressIsValid(this.address))throw new Error("Invalid Address: ".concat(this.address,"."))}var r,t,n,a,s,o;return(0,_createClass2.default)(e,[{key:"_friendlyTransaction",value:function(e,r){var t={},n={},a={amount:void 0,valueInLocal:e.inputs.map((function(e){return e.prev_out.value})).reduce((function(e,r){return e+r}))*r,valueOutLocal:e.out.map((function(e){return e.value})).reduce((function(e,r){return e+r}))*r,wasSentByMe:!1};a.amount=a.valueOutLocal;var s=!0,o=!1,i=void 0;try{for(var u,c=e.inputs.map((function(e){return e.prev_out}))[Symbol.iterator]();!(s=(u=c.next()).done);s=!0){var l=u.value;a.wasSentByMe=a.wasSentByMe||l.addr===this.address,l.valueLocal=l.value*r,t[l.addr]=!0}}catch(e){o=!0,i=e}finally{try{s||null==c.return||c.return()}finally{if(o)throw i}}var f=!0,d=!1,p=void 0;try{for(var h,y=e.out[Symbol.iterator]();!(f=(h=y.next()).done);f=!0){var v=h.value;v.valueLocal=v.value*r,v.addr&&(t[v.addr]?a.amount-=v.valueLocal:n[v.addr]=!0)}}catch(e){d=!0,p=e}finally{try{f||null==y.return||y.return()}finally{if(d)throw p}}return{amount:parseFloat((a.amount/satoshiConversion).toFixed(8)),baseTransaction:e,id:e.txid,isConfirmed:(e.confirmations||0)>=6,recipients:Object.keys(n),senders:Object.keys(t),timestamp:1e3*e.time,wasSentByMe:a.wasSentByMe}}},{key:"_friendlyTransactions",value:(o=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(r){var t,n,a,s,o,i,u=this;return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([r,this._getExchangeRates()]);case 2:return t=e.sent,n=(0,_slicedToArray2.default)(t,2),a=n[0].txs,s=void 0===a?[]:a,o=n[1],i=o[this.localCurrency],e.abrupt("return",s.map((function(e){return u._friendlyTransaction(e,i)})));case 9:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"_getExchangeRates",value:(s=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return","BTC"===this.localCurrency?{BTC:1}:getExchangeRates());case 1:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"_watchTransactions",value:function(){var e=this,r="_watchTransactions ".concat(this.address);if(!this.subjects[r]){var t=new Subject;this.subjects[r]=t;var n=new WebSocket(blockchainWebSocketURL);n.onopen=function(){n.send(JSON.stringify({op:"addr_sub",addr:e.address}))},n.onmessage=function(e){var r;try{r=JSON.parse(e.data).x.hash}catch(e){}r&&t.next(r)}}return this.subjects[r]}},{key:"createTransaction",value:(a=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(r,t){var n,a,s,o,i,u,c,l,f,d,p,h,y=this;return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isReadOnly){e.next=2;break}throw new Error("Read-only wallet");case 2:return e.next=4,Promise.all([this.getBalance(),blockchainAPIRequest("unspent",{active:this.address}).catch((function(){return{unspent_outputs:[]}}))]);case 4:if(n=e.sent,a=(0,_slicedToArray2.default)(n,2),s=a[0],o=a[1],i=((o||{}).unspent_outputs||[]).map((function(e){return{outputIndex:e.tx_output_n,satoshis:e.value,scriptPubKey:e.script,txid:e.tx_hash_big_endian}})),!((t/=s._exchangeRates[this.localCurrency])>s.btc)){e.next=12;break}throw new Error("Insufficient funds");case 12:for(u=!0,c=!1,l=void 0,e.prev=15,f=i[Symbol.iterator]();!(u=(d=f.next()).done);u=!0)p=d.value,this.originatingTransactions[p.txid]&&!p.confirmations&&(p.confirmations=1);e.next=23;break;case 19:e.prev=19,e.t0=e.catch(15),c=!0,l=e.t0;case 23:e.prev=23,e.prev=24,u||null==f.return||f.return();case 26:if(e.prev=26,!c){e.next=29;break}throw l;case 29:return e.finish(26);case 30:return e.finish(23);case 31:return h=function e(n){try{return(new BitcoreTransaction).from(i.map((function(e){return new BitcoreTransaction.UnspentOutput(e)}))).to(r.address?r.address:r.getAddress?r.getAddress().toString():r,Math.floor(t*satoshiConversion)).change(y.address).fee(transactionFee).sign(y.key)}catch(r){if(n<100&&r.message.includes("totalNeededAmount"))return t-=5e-6,e(n+1);throw r}},e.abrupt("return",h(0));case 33:case"end":return e.stop()}}),e,this,[[15,19,23,31],[24,,26,30]])}))),function(e,r){return a.apply(this,arguments)})},{key:"getBalance",value:(n=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(){var r,t,n,a,s;return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([blockchainAPIRequest("balance",{active:this.address}),this._getExchangeRates()]);case 2:r=e.sent,t=(0,_slicedToArray2.default)(r,2),n=t[0],a=t[1],s=0;try{s=n[this.address].final_balance/satoshiConversion}catch(e){}return e.abrupt("return",{_exchangeRates:a,btc:s,local:parseFloat((s*(a[this.localCurrency]||0)).toFixed(2))});case 9:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"getTransactionHistory",value:(t=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._friendlyTransactions(blockchainAPIRequest("rawaddr/".concat(this.address))));case 1:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"send",value:(r=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(r,t){var n,a,s;return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.createTransaction(r,t);case 2:return n=e.sent,a=n.id,this.originatingTransactions[a]=!0,(s=new FormData).append("tx",n.serialize()),e.abrupt("return",request(blockchainAPI("pushtx"),{body:s,method:"POST"}).then(function(){var e=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(r){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r.text());case 1:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}()));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"watchNewTransactions",value:function(){var e=this,r=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t="watchNewTransactions ".concat(this.address);return this.subjects[t]||(this.subjects[t]=this._watchTransactions().pipe(mergeMap(function(){var r=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function r(n){return _regenerator.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",lock(t,(0,_asyncToGenerator2.default)(_regenerator.default.mark((function r(){return _regenerator.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,e._friendlyTransactions(blockchainAPIRequest("rawtx/".concat(n)).then((function(e){return[e]})));case 2:return r.abrupt("return",r.sent[0]);case 3:case"end":return r.stop()}}),r)})))));case 1:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}()))),r?this.subjects[t]:this.subjects[t].pipe(map((function(e){return e.filter((function(e){return e.isConfirmed}))})))}},{key:"watchTransactionHistory",value:function(){var e=this,r=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t="watchTransactionHistory ".concat(this.address);if(!this.subjects[t]){var n=new ReplaySubject(1);this.subjects[t]=n,this.getTransactionHistory().then((function(r){n.next(r),e._watchTransactions().pipe(mergeMap((0,_asyncToGenerator2.default)(_regenerator.default.mark((function r(){return _regenerator.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",lock(t,(0,_asyncToGenerator2.default)(_regenerator.default.mark((function r(){return _regenerator.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",e.getTransactionHistory());case 1:case"end":return r.stop()}}),r)})))));case 1:case"end":return r.stop()}}),r)}))))).subscribe(n)})).catch((function(r){e.subjects[t].error(r)}))}return r?this.subjects[t]:this.subjects[t].pipe(map((function(e){return e.filter((function(e){return e.isConfirmed}))})))}}]),e}(),simplebtc={getExchangeRates:getExchangeRates,minimumTransactionAmount:BitcoreTransaction.DUST_AMOUNT/satoshiConversion,setBlockchainAPIKey:setBlockchainAPIKey,transactionFee:transactionFee/satoshiConversion,Wallet:Wallet};simplebtc.simplebtc=simplebtc,module.exports=simplebtc;