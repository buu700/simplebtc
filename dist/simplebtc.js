"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_slicedToArray2=_interopRequireDefault(require("@babel/runtime/helpers/slicedToArray")),_regenerator=_interopRequireDefault(require("@babel/runtime/regenerator")),_asyncToGenerator2=_interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator")),_typeof2=_interopRequireDefault(require("@babel/runtime/helpers/typeof"));function _createForOfIteratorHelper(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,a=function(){};return{s:a,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,i=!0,o=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return i=e.done,e},e:function(e){o=!0,s=e},f:function(){try{i||null==r.return||r.return()}finally{if(o)throw s}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var isNode="object"===("undefined"==typeof process?"undefined":(0,_typeof2.default)(process))&&"function"==typeof require&&"object"!==("undefined"==typeof window?"undefined":(0,_typeof2.default)(window))&&"function"!=typeof importScripts,rootScope=isNode?global:self,bitcore={bitcoin:{address:require("bitcore-lib/lib/address"),BitcorePrivateKey:require("bitcore-lib/lib/privatekey"),BitcoreTransaction:require("bitcore-lib/lib/transaction")},bitcoinCash:{address:require("bitcore-lib-cash/lib/address"),BitcorePrivateKey:require("bitcore-lib-cash/lib/privatekey"),BitcoreTransaction:require("bitcore-lib-cash/lib/transaction")}},FormData=require("form-data"),_require=require("rxjs"),ReplaySubject=_require.ReplaySubject,Subject=_require.Subject,_require2=require("rxjs/operators"),map=_require2.map,mergeMap=_require2.mergeMap,fetch="function"==typeof rootScope.fetch?rootScope.fetch:isNode?eval("require")("node-fetch"):require("whatwg-fetch"),sleep=function(){var e=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(){var t,r=arguments;return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.length>0&&void 0!==r[0]?r[0]:250,e.abrupt("return",new Promise((function(e){setTimeout(e,t)})));case 2:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),locks={},lock=function(){var e=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(t,r){var n,a,s=arguments;return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=s.length>2&&void 0!==s[2]?s[2]:0,locks[t]||(locks[t]=Promise.resolve()),a=locks[t].then((0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r());case 1:case"end":return e.stop()}}),e)})))),locks[t]=a.catch((function(){})).then((0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",sleep(n));case 1:case"end":return e.stop()}}),e)})))),e.abrupt("return",a);case 5:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),request=function(){var e=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(t,r){var n,a,s,i,o=arguments;return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=o.length>2&&void 0!==o[2]?o[2]:0,a=o.length>3&&void 0!==o[3]?o[3]:2,s=o.length>4&&void 0!==o[4]?o[4]:0,e.prev=3,e.next=6,lock("request",(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",fetch(t,r));case 1:case"end":return e.stop()}}),e)}))));case 6:if(200===(i=e.sent).status){e.next=9;break}throw new Error("Request failure: status ".concat(i.status.toString()));case 9:return e.abrupt("return",i);case 12:if(e.prev=12,e.t0=e.catch(3),!(s>=a)){e.next=16;break}throw e.t0;case 16:return e.next=18,sleep(n+1e3);case 18:return e.abrupt("return",request(t,r,n,a,s+1));case 19:case"end":return e.stop()}}),e,null,[[3,12]])})));return function(t,r){return e.apply(this,arguments)}}(),satoshiConversion=1e8,transactionFeesSatoshi={bitcoin:12e3,bitcoinCash:500},transactionFees={bitcoin:transactionFeesSatoshi.bitcoin/satoshiConversion,bitcoinCash:transactionFeesSatoshi.bitcoinCash/satoshiConversion},blockchainAPIKey=void 0,blockchainAPIURL="https://api.blockchain.info/haskoin-store/",blockchainWebSocketURL="wss://ws.blockchain.info/inv",blockchainAPI=function(e,t,r){return blockchainAPIURL+(e?"bch/":"btc/")+t},blockchainAPIRequest=function(){var e=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(t,r,n){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",request(blockchainAPI(t,r,n),void 0,1e4).then(function(){var e=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(t){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.json());case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),getExchangeRates=function(){var e=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(t){var r,n,a,s,i,o,c;return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([request("https://blockchain.info/ticker").then(function(){var e=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(t){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.json());case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t?(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,request("https://api.coingecko.com/api/v3/exchange_rates").then((function(e){return e.json()}));case 2:return e.abrupt("return",e.sent.rates.bch.value);case 3:case"end":return e.stop()}}),e)})))():1]);case 2:for(r=e.sent,n=(0,_slicedToArray2.default)(r,2),a=n[0],s=n[1],i=0,o=Object.keys(a);i<o.length;i++)c=o[i],a[c]=a[c].last,t&&(a[c]=parseFloat((a[c]/s).toFixed(2)));return a.BTC=1,e.abrupt("return",a);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),setBlockchainAPIKey=function(e){blockchainAPIKey=e},Wallet=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if((0,_classCallCheck2.default)(this,e),this.apiKey=t.apiKey,this.bitcoinCash=!0===t.bitcoinCash,this.bitcore=this.bitcoinCash?bitcore.bitcoinCash:bitcore.bitcoin,this.transactionFee=this.bitcoinCash?transactionFees.bitcoinCash:transactionFees.bitcoin,this.transactionFeeSatoshi=this.bitcoinCash?transactionFeesSatoshi.bitcoinCash:transactionFeesSatoshi.bitcoin,t instanceof e)return this.address=t.address,this.isReadOnly=t.isReadOnly,this.localCurrency=t.localCurrency,this.key=t.key,this.originatingTransactions=t.originatingTransactions,void(this.subjects={});this.localCurrency=t.localCurrency||"BTC";var r="string"==typeof t.key?new this.bitcore.BitcorePrivateKey(t.key,"livenet").toBuffer():t.key instanceof Uint8Array?t.key:void 0;if(void 0!==r?this.key=this.bitcore.BitcorePrivateKey.fromObject({bn:r,compressed:!t.uncompressedPublicKey,network:"livenet"}):t.address||(this.key=new this.bitcore.BitcorePrivateKey(void 0,"livenet")),this.isReadOnly=void 0===this.key,this.address=this.isReadOnly?t.address:this.key.toAddress().toString(),this.originatingTransactions={},this.subjects={},!this.bitcore.address.isValid(this.address)){if(!this.bitcoinCash||!bitcore.bitcoin.address.isValid(this.address))throw new Error("Invalid Address: ".concat(this.address,"."));this.address=bitcore.bitcoinCash.address.fromPublicKeyHash(bitcore.bitcoin.address.fromString(this.address).hashBuffer).toString()}}var t,r,n,a,s,i;return(0,_createClass2.default)(e,[{key:"_friendlyTransaction",value:function(e,t){var r={},n={},a={amount:void 0,valueInLocal:e.inputs.map((function(e){return e.value})).reduce((function(e,t){return e+t}),0)*t,valueOutLocal:e.outputs.map((function(e){return e.value})).reduce((function(e,t){return e+t}),0)*t,wasSentByMe:!1};a.amount=a.valueOutLocal;var s,i=_createForOfIteratorHelper(e.inputs);try{for(i.s();!(s=i.n()).done;){var o=s.value;a.wasSentByMe=a.wasSentByMe||o.address===this.address,o.valueLocal=o.value*t,r[o.address]=!0}}catch(e){i.e(e)}finally{i.f()}var c,u=_createForOfIteratorHelper(e.outputs);try{for(u.s();!(c=u.n()).done;){var l=c.value;l.valueLocal=l.value*t,l.address&&(r[l.address]?a.amount-=l.valueLocal:n[l.address]=!0)}}catch(e){u.e(e)}finally{u.f()}return{amount:parseFloat((a.amount/satoshiConversion).toFixed(8)),baseTransaction:e,id:e.txid,isConfirmed:!e.rbf,recipients:Object.keys(n),senders:Object.keys(r),timestamp:1e3*e.time,wasSentByMe:a.wasSentByMe}}},{key:"_friendlyTransactions",value:(i=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(t){var r,n,a,s,i,o=this;return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([t,this._getExchangeRates()]);case 2:return r=e.sent,n=(0,_slicedToArray2.default)(r,2),a=n[0],s=n[1],i=s[this.localCurrency],e.abrupt("return",(a||[]).map((function(e){return o._friendlyTransaction(e,i)})));case 8:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"_getExchangeRates",value:(s=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return","BTC"===this.localCurrency?{BTC:1}:getExchangeRates(this.bitcoinCash));case 1:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"_watchTransactions",value:function(){var e=this,t="_watchTransactions ".concat(this.address);if(!this.subjects[t]){var r=new Subject;if(this.subjects[t]=r,this.bitcoinCash)return r;var n=new WebSocket(blockchainWebSocketURL);n.onopen=function(){n.send(JSON.stringify({op:"addr_sub",addr:e.address}))},n.onmessage=function(e){var t;try{t=JSON.parse(e.data).x.hash}catch(e){}t&&r.next(t)}}return this.subjects[t]}},{key:"createTransaction",value:(a=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(t,r){var n,a,s,i,o,c,u,l,f,d=this;return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isReadOnly){e.next=2;break}throw new Error("Read-only wallet");case 2:return e.next=4,Promise.all([this.getBalance(),blockchainAPIRequest(this.bitcoinCash,"address/".concat(this.address,"/unspent")).catch((function(){return[]}))]);case 4:if(n=e.sent,a=(0,_slicedToArray2.default)(n,2),s=a[0],i=a[1],o=(i||[]).map((function(e){return{outputIndex:e.index,satoshis:e.value,scriptPubKey:e.pkscript,txid:e.txid}})),!((r/=s._exchangeRates[this.localCurrency])>s.btc)){e.next=12;break}throw new Error("Insufficient funds");case 12:c=_createForOfIteratorHelper(o);try{for(c.s();!(u=c.n()).done;)l=u.value,this.originatingTransactions[l.txid]&&!l.confirmations&&(l.confirmations=1)}catch(e){c.e(e)}finally{c.f()}return f=function e(n){try{return(new d.bitcore.BitcoreTransaction).from(o.map((function(e){return new d.bitcore.BitcoreTransaction.UnspentOutput(e)}))).to(t.address?t.address:t.getAddress?t.getAddress().toString():t,Math.floor(r*satoshiConversion)).change(d.address).fee(d.transactionFeeSatoshi).sign(d.key)}catch(t){if(n<100&&t.message.includes("totalNeededAmount"))return r-=5e-6,e(n+1);throw t}},e.abrupt("return",f(0));case 16:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"getBalance",value:(n=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(){var t,r,n,a,s;return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([blockchainAPIRequest(this.bitcoinCash,"address/".concat(this.address,"/balance")),this._getExchangeRates()]);case 2:t=e.sent,r=(0,_slicedToArray2.default)(t,2),n=r[0],a=r[1],s=0;try{s=n.confirmed/satoshiConversion}catch(e){}return e.abrupt("return",{_exchangeRates:a,btc:s,local:parseFloat((s*(a[this.localCurrency]||0)).toFixed(2))});case 9:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"getTransactionHistory",value:(r=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this._friendlyTransactions(blockchainAPIRequest(this.bitcoinCash,"address/".concat(this.address,"/transactions/full"))));case 1:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"send",value:(t=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(t,r){var n,a,s,i;return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.createTransaction(t,r);case 2:if(n=e.sent,a=n.id,this.originatingTransactions[a]=!0,s=n.serialize(),!this.bitcoinCash){e.next=8;break}return e.abrupt("return",request("https://rest.bitcoin.com/v2/rawtransactions/sendRawTransaction/".concat(s)).then(function(){var e=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(t){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.text());case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 8:return(i=new FormData).append("tx",s),e.abrupt("return",request("https://blockchain.info/pushtx",{body:i,method:"POST"}).then(function(){var e=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function e(t){return _regenerator.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.text());case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 11:case"end":return e.stop()}}),e,this)}))),function(e,r){return t.apply(this,arguments)})},{key:"watchNewTransactions",value:function(){var e=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],r="watchNewTransactions ".concat(this.address);return this.subjects[r]||(this.subjects[r]=this._watchTransactions().pipe(mergeMap(function(){var t=(0,_asyncToGenerator2.default)(_regenerator.default.mark((function t(n){return _regenerator.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",lock(r,(0,_asyncToGenerator2.default)(_regenerator.default.mark((function t(){return _regenerator.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e._friendlyTransactions(blockchainAPIRequest(e.bitcoinCash,"transactions/".concat(n)).then((function(e){return[e]})));case 2:return t.abrupt("return",t.sent[0]);case 3:case"end":return t.stop()}}),t)})))));case 1:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()))),t?this.subjects[r]:this.subjects[r].pipe(map((function(e){return e.filter((function(e){return e.isConfirmed}))})))}},{key:"watchTransactionHistory",value:function(){var e=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],r="watchTransactionHistory ".concat(this.address);if(!this.subjects[r]){var n=new ReplaySubject(1);this.subjects[r]=n,this.getTransactionHistory().then((function(t){n.next(t),e._watchTransactions().pipe(mergeMap((0,_asyncToGenerator2.default)(_regenerator.default.mark((function t(){return _regenerator.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",lock(r,(0,_asyncToGenerator2.default)(_regenerator.default.mark((function t(){return _regenerator.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.getTransactionHistory());case 1:case"end":return t.stop()}}),t)})))));case 1:case"end":return t.stop()}}),t)}))))).subscribe(n)})).catch((function(t){e.subjects[r].error(t)}))}return t?this.subjects[r]:this.subjects[r].pipe(map((function(e){return e.filter((function(e){return e.isConfirmed}))})))}}]),e}(),simplebtc={getExchangeRates:getExchangeRates,minimumTransactionAmount:bitcore.bitcoin.BitcoreTransaction.DUST_AMOUNT/satoshiConversion,setBlockchainAPIKey:setBlockchainAPIKey,transactionFees:transactionFees,transactionFeesSatoshi:transactionFeesSatoshi,Wallet:Wallet};simplebtc.simplebtc=simplebtc,module.exports=simplebtc;